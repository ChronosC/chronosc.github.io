# https协议

## 1，https - `Hyper Text Transfer Protocol over Secure Socket Layer`

安全的超文本传输协议，网景公式设计了SSL(Secure Sockets Layer)协议用于对Http协议传输的数据进行加密，保证会话过程中的安全性。

### 1.1，http - `Hyper Text Transfer Protocol`

超文本传输协议，是互联网上使用最广泛的一种协议，所有WWW文件必须遵循的标准。HTTP协议传输的数据都是未加密的，也就是明文的，因此使用HTTP协议传输隐私信息非常不安全。

### 1.2，http 与 https 的区别

1. `https`协议需要到`CA`申请数字证书，有免费的也有收费的，也可以自己颁发自定义证书（例如：12306）
1. `http`信息是明文传输，`https`则是具有安全性的ssl/tls加密传输协议
1. 端口不一样，`http`是80，`https`是443

> `HTTPS` = `HTTP` + `SSL/TLS`（`机密`，`完整`，`抗否认`）

## 2，数字证书 - `Digital Certificate`

类似身份证，用于标识网络中用户（计算机）的身份。
现实中身份证需由公安机关颁发，而网络用户（计算机）的身份凭证则需由数字证书颁发认证机构（Certificate Authority）签发。

### 2.1，作用
1. 加密
1. 解密
1. 签名
1. 验证

> 对数据作非对称加密与消息摘要，叫作数字签名，比如：`RSA` + `SHA256`

### 2.2，应用
采用了公钥基础设施 - `Public Key Infrastructure，PKI`
1. 非对称加密算法用于对数据进行加密/解密操作，确保数据机密性
1. 消息摘要算法用于对数字证书本身做摘要处理，确保证书完整性
1. 数字签名算法用于对数据进行签名/验证操作，确保数据完整性和抗否认性

### 2.3，数字证书颁发认证机构 - `Certificate Authority`

1. 收费："三巨头"
    1. `VeriSign` - http://www.verisign.com 
    1. `GeoTrust` - http://www.geotrust.com
    1. `Thawte` - http://www.thawte.com
1. 免费：
    1. `CAcert` - http://www.cacert.org
    1. `Letsencrypt` - https://letsencrypt.org

## 3，SSL/TLS协议

### 3.1，SSL - `Secure Socket Layer`

由Netscape（网景）公司研发，位于TCP/IP参考模型中的网络传输层

### 3.2，TLS - `Transport Layer Security`

基于SSL协议之上的通用化协议，同样位于TCP/IP参考模型中的网络传输层，是SSL协议继任者

### 3.3，相关加密算法

SSL/TLS涉及多种加密算法，包含消息摘要算法、对称加密算法、非对称加密算法，以及数字签名算法

1. 消息摘要算法：MD5、SHA-1、SHA-2、SHA-256、SHA-512、SHA-3
1. 对称加密算法：RC2、RC4、RC5、IDEA、DES、Triple DES、AES
1. 非对称加密算法：RSA、Diffie-Hellman（DH）
1. 数字签名算法：RSA、DSA

## 4，协议模型

### 4.1，协商算法

1. 客户端产生随机数`RNC`（Random Number Client），为后续构建密钥做准备
1. 客户端将自身支持的SSL信息（版本和种类）、算法信息和随机数RNC发送到服务器
1. 服务器收到客户端请求后，产生相应的随机数`RNS`（Random Number Server）为后续构建密钥做准备
1. 服务器将自身支持的SSL信息（版本和种类）、算法信息和随机数RNS和其他信息（服务器证书、获取客户端证书的请求）返回给客户端

至此，客户端和服务端已经确认两方交互时所使用的加密算法

### 4.2 验证证书

#### 4.2.1 单向认证

如果服务端回复客户端时带有其他信息，将进入验证数字证书阶段

1. 服务器回复客户端响应时带有服务器证书
1. 客户端将该证书发送至认证机构
1. 认证机构验证该证书，回应客户端认证结果

如果认证通过，客户端和服务器可以进行以服务端单向认证为基础的加密交互

#### 4.2.2 双向认证
如果服务端要求客户端提供客户证书，将构建基于服务端和客户端两方的双向认证基础
服务端验证客户端证书包含以下几个步骤

1. 服务端请求客户证书
1. 客户端发送客户证书
1. 服务端将客户证书发送至认证机构验证
1. 认证机构验证该证书，回应服务端认证结果

> 双向认证可防止中间人攻击（`Man-in-the-Middle Attack`）

### 4.3 产生密钥

1. 客户端产生随机数，作为预备主密钥（Pre-Master Secret，PMS）
1. 客户端使用服务端证书中的公钥对随机数PMS进行加密，发送至服务器
1. 服务端使用私钥对信息进行解密获得PMS
1. 客户端使用随机数RNC、RNS和PMS构建主密钥（Master Secret，MS）
1. 服务端使用随机数RNC、RNS和PMS构建主密钥（Master Secret，MS）
1. 双方使用主密钥构建会话密钥（即对称加密算法密钥），并相互通知，双方确认后终止握手

### 4.4 加密交互

1. 客户端使用会话密钥对信息加密，并向服务器发送加密信息
1. 服务端使用会话密钥对加密信息进行解密，处理请求
1. 服务端完成处理请求后，使用会话密钥对回复信息进行加密，返回加密信息
1. 客户端使用会话密钥对返回的加密信息进行解密

